{% extends "base.html" %}
{% block title %}Profile - SocialChain{% endblock %}
{% block content %}
<div class="row g-3">
    <div class="col-12">
        <h4 class="text-info"><i class="bi bi-person"></i> Agent Profile</h4>
    </div>

    {% if profile %}
    {# ── LEFT COLUMN ── #}
    <div class="col-md-4">
        <div class="card bg-black border-secondary">
            <div class="card-body text-center p-4">

                {# Hexagonal avatar #}
                <div class="sc-hex-avatar">
                    {% if profile.device_type == 'agent' %}
                    <i class="bi bi-robot text-warning"></i>
                    {% else %}
                    <i class="bi bi-person-circle text-light"></i>
                    {% endif %}
                </div>

                <h4 class="text-light mb-1">{{ profile.display_name }}</h4>

                <span class="badge {{ 'bg-warning text-dark' if profile.device_type == 'agent' else 'bg-info text-dark' }}">
                    {{ profile.device_type | upper }}
                </span>
                {% if did == user_did %}
                <span class="badge bg-success ms-1">You</span>
                {% endif %}

                <hr class="border-secondary">

                {# Blockchain verification badge #}
                <div class="mb-2">
                    {% if profile.metadata and profile.metadata.get('blockchain_status') == 'verified' %}
                    <span class="sc-chain-badge">
                        &#10003; Blockchain Verified
                    </span>
                    {% if profile.metadata.get('last_verified') %}
                    <div class="text-secondary mt-1" style="font-size:0.65rem;">
                        Last verified: {{ profile.metadata.last_verified }}
                    </div>
                    {% endif %}
                    {% else %}
                    <span class="sc-chain-badge" style="background:rgba(255,193,7,0.12);border-color:#ffc107;color:#ffc107;box-shadow:0 0 8px rgba(255,193,7,0.25);">
                        &#9888; Not Yet Verified
                    </span>
                    {% endif %}
                </div>

                {% if did == user_did %}
                <button class="btn btn-sm btn-outline-info mt-1 mb-3" onclick="verifyProfile()">
                    <i class="bi bi-shield-check"></i> Re-verify on Blockchain
                </button>
                <div id="verify-result" class="small mb-2"></div>
                {% endif %}

                <hr class="border-secondary">

                {# DID identity #}
                <div class="text-start">
                    <div class="text-secondary small mb-1">DID Identity</div>
                    <code class="text-warning" style="font-size:0.65rem;word-break:break-all;">{{ profile.did }}</code>
                </div>

                {# QR code placeholder #}
                <div class="mt-3">
                    <div class="sc-qr-placeholder mx-auto">QR Code</div>
                </div>

            </div>
        </div>
    </div>

    {# ── RIGHT COLUMN ── #}
    <div class="col-md-8">

        {# Connections card #}
        <div class="card bg-black border-secondary mb-3">
            <div class="card-header border-secondary">
                <i class="bi bi-people"></i> Connections ({{ connections | length }})
            </div>
            <div class="card-body">
                {% if connections %}
                <div class="row g-2">
                    {% for conn in connections %}
                    <div class="col-md-6">
                        <a href="{{ url_for('web.profile', did=conn.did) }}" class="text-decoration-none">
                            <div class="card bg-dark border-secondary p-2 d-flex flex-row align-items-center gap-2">
                                <i class="bi {{ 'bi-robot text-warning' if conn.device_type == 'agent' else 'bi-person-circle text-info' }} fs-4"></i>
                                <div>
                                    <div class="text-light small fw-bold">{{ conn.display_name }}</div>
                                    <div class="text-secondary" style="font-size:0.65rem;">{{ conn.did[:32] }}...</div>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-secondary">No connections yet.</p>
                {% endif %}
            </div>
        </div>

        {# Connect with Agent form (own profile only) #}
        {% if did == user_did %}
        <div class="card bg-black border-secondary mb-3">
            <div class="card-header border-secondary"><i class="bi bi-person-plus"></i> Connect with Agent</div>
            <div class="card-body">
                <form id="connect-form" class="d-flex gap-2">
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="connect-did" placeholder="Target DID (did:socialchain:...)" required>
                    <button type="submit" class="btn btn-sm btn-info flex-shrink-0">Connect</button>
                </form>
                <div id="connect-result" class="mt-2 small"></div>
            </div>
        </div>
        {% endif %}

        {# Social Media Links card #}
        <div class="card bg-black border-secondary mb-3">
            <div class="card-header border-secondary"><i class="bi bi-share"></i> Social Media Links</div>
            <div class="card-body">

                {% if did == user_did %}
                {% set sl = profile.metadata.get('social_links', {}) if profile.metadata else {} %}
                <form id="social-links-form" class="mb-3">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label text-secondary small"><i class="bi bi-facebook" style="color:#1877f2;"></i> Facebook</label>
                            <input type="url" class="form-control form-control-sm bg-dark text-light border-secondary" id="sl-facebook" placeholder="https://facebook.com/..." value="{{ sl.get('facebook', '') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary small"><i class="bi bi-linkedin" style="color:#0a66c2;"></i> LinkedIn</label>
                            <input type="url" class="form-control form-control-sm bg-dark text-light border-secondary" id="sl-linkedin" placeholder="https://linkedin.com/in/..." value="{{ sl.get('linkedin', '') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary small"><i class="bi bi-instagram" style="color:#e1306c;"></i> Instagram</label>
                            <input type="url" class="form-control form-control-sm bg-dark text-light border-secondary" id="sl-instagram" placeholder="https://instagram.com/..." value="{{ sl.get('instagram', '') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary small"><i class="bi bi-youtube" style="color:#ff0000;"></i> YouTube</label>
                            <input type="url" class="form-control form-control-sm bg-dark text-light border-secondary" id="sl-youtube" placeholder="https://youtube.com/..." value="{{ sl.get('youtube', '') }}">
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="saveSocialLinks()">
                                <i class="bi bi-save"></i> Save Links
                            </button>
                            <span id="sl-result" class="ms-2 small"></span>
                        </div>
                    </div>
                </form>
                {% endif %}

                {# Display existing links for everyone #}
                {% if profile.metadata and profile.metadata.get('social_links') %}
                {% set sl = profile.metadata.social_links %}
                <div class="d-flex flex-wrap gap-2">
                    {% if sl.get('facebook') %}
                    <a href="{{ sl.facebook }}" target="_blank" rel="noopener" class="sc-social-badge facebook text-decoration-none">
                        <i class="bi bi-facebook"></i> Facebook
                    </a>
                    {% endif %}
                    {% if sl.get('linkedin') %}
                    <a href="{{ sl.linkedin }}" target="_blank" rel="noopener" class="sc-social-badge linkedin text-decoration-none">
                        <i class="bi bi-linkedin"></i> LinkedIn
                    </a>
                    {% endif %}
                    {% if sl.get('instagram') %}
                    <a href="{{ sl.instagram }}" target="_blank" rel="noopener" class="sc-social-badge instagram text-decoration-none">
                        <i class="bi bi-instagram"></i> Instagram
                    </a>
                    {% endif %}
                    {% if sl.get('youtube') %}
                    <a href="{{ sl.youtube }}" target="_blank" rel="noopener" class="sc-social-badge youtube text-decoration-none">
                        <i class="bi bi-youtube"></i> YouTube
                    </a>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-secondary small mb-0">No social links added yet.</p>
                {% endif %}
            </div>
        </div>

        {# External Contacts card (own profile only) #}
        {% if did == user_did %}
        <div class="card bg-black border-secondary mb-3">
            <div class="card-header border-secondary"><i class="bi bi-person-lines-fill"></i> External Contacts</div>
            <div class="card-body">
                {% set ext_contacts = profile.metadata.get('external_contacts', []) if profile.metadata else [] %}
                {% if ext_contacts %}
                <div class="row g-2">
                    {% for contact in ext_contacts %}
                    <div class="col-12">
                        <div class="d-flex align-items-center justify-content-between p-2 rounded bg-dark border border-secondary">
                            <div>
                                <span class="text-light small fw-bold">{{ contact.name }}</span>
                                <span class="ms-2 sc-social-badge {{ contact.platform | lower }}">
                                    <i class="bi bi-{{ contact.platform | lower }}"></i>
                                    {{ contact.platform }}
                                </span>
                                <span class="text-secondary ms-1" style="font-size:0.7rem;">{{ contact.platform_id }}</span>
                            </div>
                            <div>
                                {% if contact.get('invited') %}
                                <span class="badge bg-success">Invited</span>
                                {% else %}
                                <button class="btn btn-sm btn-outline-info"
                                    onclick="inviteContact('{{ contact.platform_id }}', '{{ contact.platform }}', '{{ contact.name }}', this)">
                                    <i class="bi bi-envelope"></i> Invite
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-secondary small mb-0">No external contacts found.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {# Social Requests card #}
        <div class="card bg-black border-secondary mb-3">
            <div class="card-header border-secondary"><i class="bi bi-send"></i> Social Requests</div>
            <div class="card-body">
                <form id="request-form">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label text-secondary small">Target DID</label>
                            <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary" id="req-target" placeholder="did:socialchain:..." required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary small">Action</label>
                            <select class="form-select form-select-sm bg-dark text-light border-secondary" id="req-action">
                                <option value="SEND_MESSAGE">Send Message</option>
                                <option value="REQUEST_FEATURE">Request Feature</option>
                                <option value="CHANGE_FEATURE">Change Feature</option>
                                <option value="DEPLOY_AGENT">Deploy Agent</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label text-secondary small">Payload (JSON)</label>
                            <textarea class="form-control form-control-sm bg-dark text-light border-secondary" id="req-payload" rows="2" placeholder='{"message": "Hello!"}'></textarea>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-sm btn-outline-info">Send Request</button>
                            <span id="req-result" class="ms-2 small"></span>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        {# Recent Blockchain Activity card #}
        <div class="card bg-black border-secondary">
            <div class="card-header border-secondary"><i class="bi bi-activity"></i> Recent Blockchain Activity</div>
            <div class="card-body">
                <div id="activity-feed">
                    <p class="text-secondary small">Loading activity...</p>
                </div>
            </div>
        </div>

    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-warning">Profile not found for DID: <code>{{ did }}</code></div>
        <a href="{{ url_for('web.profile') }}" class="btn btn-info">View Your Profile</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
const USER_DID = "{{ user_did }}";
const PROFILE_DID = "{{ did }}";

{% if did == user_did %}
// Connect with another agent
document.getElementById('connect-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const targetDid = document.getElementById('connect-did').value.trim();
    const res = await fetch('/api/social/connections', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({did_a: USER_DID, did_b: targetDid})
    });
    const result = await res.json();
    const el = document.getElementById('connect-result');
    if (res.ok) {
        el.className = 'text-success';
        el.textContent = result.message;
        setTimeout(() => location.reload(), 1000);
    } else {
        el.className = 'text-danger';
        el.textContent = result.error || 'Error';
    }
});

// Verify profile on blockchain
async function verifyProfile() {
    const el = document.getElementById('verify-result');
    el.className = 'text-secondary';
    el.textContent = 'Verifying...';
    try {
        const res = await fetch(`/api/social/profiles/${PROFILE_DID}/verify`, {method: 'POST'});
        const result = await res.json();
        if (res.ok) {
            el.className = 'text-success';
            el.textContent = result.message || 'Verification submitted.';
            setTimeout(() => location.reload(), 1500);
        } else {
            el.className = 'text-danger';
            el.textContent = result.error || 'Verification failed.';
        }
    } catch (err) {
        el.className = 'text-danger';
        el.textContent = 'Network error.';
    }
}

// Save social links
async function saveSocialLinks() {
    const el = document.getElementById('sl-result');
    const links = {
        facebook:  document.getElementById('sl-facebook').value.trim(),
        linkedin:  document.getElementById('sl-linkedin').value.trim(),
        instagram: document.getElementById('sl-instagram').value.trim(),
        youtube:   document.getElementById('sl-youtube').value.trim()
    };
    Object.keys(links).forEach(k => { if (!links[k]) delete links[k]; });
    el.className = 'text-secondary';
    el.textContent = 'Saving...';
    try {
        const res = await fetch(`/api/social/profiles/${PROFILE_DID}/social-links`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({social_links: links})
        });
        const result = await res.json();
        if (res.ok) {
            el.className = 'text-success';
            el.textContent = 'Links saved!';
            setTimeout(() => location.reload(), 1000);
        } else {
            el.className = 'text-danger';
            el.textContent = result.error || 'Save failed.';
        }
    } catch (err) {
        el.className = 'text-danger';
        el.textContent = 'Network error.';
    }
}

// Invite external contact
async function inviteContact(platformId, platform, name, btn) {
    btn.disabled = true;
    btn.textContent = 'Inviting...';
    try {
        const res = await fetch('/api/social/external-contacts/invite', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({platform_id: platformId, platform: platform, name: name, inviter_did: USER_DID})
        });
        if (res.ok) {
            btn.outerHTML = '<span class="badge bg-success">Invited</span>';
        } else {
            btn.disabled = false;
            btn.textContent = 'Invite';
        }
    } catch (err) {
        btn.disabled = false;
        btn.textContent = 'Invite';
    }
}
{% endif %}

// Send social request
document.getElementById('request-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const target = document.getElementById('req-target').value.trim();
    const action = document.getElementById('req-action').value;
    let payload = {};
    const rawPayload = document.getElementById('req-payload').value || '{}';
    try { payload = JSON.parse(rawPayload); } catch(err) {
        const el = document.getElementById('req-result');
        el.className = 'text-danger';
        el.textContent = 'Invalid JSON in payload field';
        return;
    }
    const res = await fetch('/api/social/requests', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({requester_did: USER_DID, target_did: target, action: action, payload: payload})
    });
    const result = await res.json();
    const el = document.getElementById('req-result');
    if (res.ok) {
        el.className = 'text-success';
        el.textContent = 'Request sent!';
    } else {
        el.className = 'text-danger';
        el.textContent = result.error || 'Error';
    }
});

// Load recent blockchain activity filtered to this profile's status_update transactions
async function loadActivity() {
    const feed = document.getElementById('activity-feed');
    if (!feed) return;
    try {
        const res = await fetch('/api/chain');
        if (!res.ok) throw new Error('Chain unavailable');
        const chain = await res.json();

        const blocks = Array.isArray(chain) ? chain : (chain.chain || chain.blocks || []);
        const txs = [];
        blocks.forEach(block => {
            const blockTxs = block.transactions || block.data || [];
            if (Array.isArray(blockTxs)) {
                blockTxs.forEach(tx => {
                    if (tx.sender === PROFILE_DID && tx.data && tx.data.type === 'status_update') {
                        txs.push({...tx, block_index: block.index, timestamp: block.timestamp || tx.timestamp});
                    }
                });
            }
        });

        const recent = txs.slice(-5).reverse();
        if (recent.length === 0) {
            feed.innerHTML = '<p class="text-secondary small mb-0">No recent activity found.</p>';
            return;
        }

        feed.innerHTML = recent.map(tx => {
            const ts = tx.timestamp
                ? new Date(typeof tx.timestamp === 'number' ? tx.timestamp * 1000 : tx.timestamp).toLocaleString()
                : 'Unknown time';
            const msg = (tx.data && tx.data.message) ? tx.data.message : JSON.stringify(tx.data || {});
            return `<div class="sc-activity-item">
                <div class="d-flex justify-content-between">
                    <span class="text-info small fw-bold"><i class="bi bi-box"></i> Block #${tx.block_index ?? '?'}</span>
                    <span class="text-secondary" style="font-size:0.7rem;">${ts}</span>
                </div>
                <div class="text-light mt-1" style="font-size:0.8rem;">${msg}</div>
            </div>`;
        }).join('');
    } catch (err) {
        feed.innerHTML = '<p class="text-secondary small mb-0">Could not load blockchain activity.</p>';
    }
}

loadActivity();
</script>
{% endblock %}
