{% extends "base.html" %}
{% block title %}Profile - SocialChain{% endblock %}
{% block content %}
<div class="row g-3">
    <div class="col-12">
        <h4 class="text-info"><i class="bi bi-person"></i> Agent Profile</h4>
    </div>

    {% if profile %}
    <div class="col-md-4">
        <div class="card bg-black border-secondary">
            <div class="card-body text-center p-4">
                <div class="display-1 mb-3">
                    {% if profile.device_type == 'agent' %}
                    <i class="bi bi-robot text-warning"></i>
                    {% else %}
                    <i class="bi bi-person-circle text-info"></i>
                    {% endif %}
                </div>
                <h4 class="text-light">{{ profile.display_name }}</h4>
                <span class="badge {{ 'bg-warning text-dark' if profile.device_type == 'agent' else 'bg-info text-dark' }}">
                    {{ profile.device_type | upper }}
                </span>
                {% if did == user_did %}
                <div class="mt-2"><span class="badge bg-success">You</span></div>
                {% endif %}
                <hr class="border-secondary">
                <div class="text-start">
                    <div class="text-secondary small mb-1">DID Identity</div>
                    <code class="text-warning" style="font-size:0.65rem;word-break:break-all;">{{ profile.did }}</code>
                </div>
                {% if profile.metadata %}
                <div class="text-start mt-2">
                    <div class="text-secondary small mb-1">Metadata</div>
                    <pre class="text-light" style="font-size:0.7rem;">{{ profile.metadata | tojson(indent=2) }}</pre>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card bg-black border-secondary mb-3">
            <div class="card-header border-secondary">
                <i class="bi bi-people"></i> Connections ({{ connections | length }})
            </div>
            <div class="card-body">
                {% if connections %}
                <div class="row g-2">
                    {% for conn in connections %}
                    <div class="col-md-6">
                        <a href="{{ url_for('web.profile', did=conn.did) }}" class="text-decoration-none">
                            <div class="card bg-dark border-secondary p-2 d-flex flex-row align-items-center gap-2">
                                <i class="bi {{ 'bi-robot text-warning' if conn.device_type == 'agent' else 'bi-person-circle text-info' }} fs-4"></i>
                                <div>
                                    <div class="text-light small fw-bold">{{ conn.display_name }}</div>
                                    <div class="text-secondary" style="font-size:0.65rem;">{{ conn.did[:32] }}...</div>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-secondary">No connections yet.</p>
                {% endif %}
            </div>
        </div>

        {% if did == user_did %}
        <div class="card bg-black border-secondary mb-3">
            <div class="card-header border-secondary"><i class="bi bi-person-plus"></i> Connect with Agent</div>
            <div class="card-body">
                <form id="connect-form" class="d-flex gap-2">
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="connect-did" placeholder="Target DID (did:socialchain:...)" required>
                    <button type="submit" class="btn btn-sm btn-info flex-shrink-0">Connect</button>
                </form>
                <div id="connect-result" class="mt-2 small"></div>
            </div>
        </div>
        {% endif %}

        <div class="card bg-black border-secondary">
            <div class="card-header border-secondary"><i class="bi bi-send"></i> Social Requests</div>
            <div class="card-body">
                <form id="request-form">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label text-secondary small">Target DID</label>
                            <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary" id="req-target" placeholder="did:socialchain:..." required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary small">Action</label>
                            <select class="form-select form-select-sm bg-dark text-light border-secondary" id="req-action">
                                <option value="SEND_MESSAGE">Send Message</option>
                                <option value="REQUEST_FEATURE">Request Feature</option>
                                <option value="CHANGE_FEATURE">Change Feature</option>
                                <option value="DEPLOY_AGENT">Deploy Agent</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label text-secondary small">Payload (JSON)</label>
                            <textarea class="form-control form-control-sm bg-dark text-light border-secondary" id="req-payload" rows="2" placeholder='{"message": "Hello!"}'></textarea>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-sm btn-outline-info">Send Request</button>
                            <span id="req-result" class="ms-2 small"></span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-warning">Profile not found for DID: <code>{{ did }}</code></div>
        <a href="{{ url_for('web.profile') }}" class="btn btn-info">View Your Profile</a>
    </div>
    {% endif %}
</div>
{% endblock %}
{% block scripts %}
<script>
const USER_DID = "{{ user_did }}";
const PROFILE_DID = "{{ did }}";

{% if did == user_did %}
// Connect with another agent
document.getElementById('connect-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const targetDid = document.getElementById('connect-did').value.trim();
    const res = await fetch('/api/social/connections', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({did_a: USER_DID, did_b: targetDid})
    });
    const result = await res.json();
    const el = document.getElementById('connect-result');
    if (res.ok) {
        el.className = 'text-success';
        el.textContent = result.message;
        setTimeout(() => location.reload(), 1000);
    } else {
        el.className = 'text-danger';
        el.textContent = result.error || 'Error';
    }
});
{% endif %}

// Send social request
document.getElementById('request-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const target = document.getElementById('req-target').value.trim();
    const action = document.getElementById('req-action').value;
    let payload = {};
    const rawPayload = document.getElementById('req-payload').value || '{}';
    try { payload = JSON.parse(rawPayload); } catch(err) {
        const el = document.getElementById('req-result');
        el.className = 'text-danger';
        el.textContent = 'Invalid JSON in payload field';
        return;
    }
    const res = await fetch('/api/social/requests', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({requester_did: USER_DID, target_did: target, action: action, payload: payload})
    });
    const result = await res.json();
    const el = document.getElementById('req-result');
    if (res.ok) {
        el.className = 'text-success';
        el.textContent = 'Request sent!';
    } else {
        el.className = 'text-danger';
        el.textContent = result.error || 'Error';
    }
});
</script>
{% endblock %}
