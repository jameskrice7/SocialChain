{% extends "base.html" %}
{% block title %}Earth Network — SocialChain{% endblock %}

{% block content %}
<style>
#sc-bg-canvas { display: none !important; }
#sc-earth-page {
    display:flex; flex-direction:column;
    height:calc(100vh - 64px);
    margin:-1rem -1.5rem 0;
    overflow:hidden; background:#00000a;
}
#sc-earth-topbar {
    flex-shrink:0; display:flex; align-items:center;
    justify-content:space-between; gap:.5rem; padding:.45rem 1rem;
    background:rgba(0,0,10,.78); backdrop-filter:blur(12px);
    border-bottom:1px solid rgba(13,202,240,.18);
    z-index:20; flex-wrap:wrap;
}
#sc-earth-main { flex:1; position:relative; overflow:hidden; }
#sc-earth-canvas-wrap { position:absolute; inset:0; overflow:hidden; }
#sc-earth-canvas-wrap canvas { display:block; }
#sc-earth-loading {
    position:absolute; inset:0; display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    background:rgba(0,0,14,.92); z-index:50; gap:.8rem;
    font-size:.9rem; color:#6c757d; transition:opacity .5s;
}
#sc-earth-loading.hidden { opacity:0; pointer-events:none; }
#sc-earth-sidebar {
    position:absolute; top:0; right:0; bottom:0;
    width:280px; background:rgba(4,4,16,.88);
    backdrop-filter:blur(14px);
    border-left:1px solid rgba(13,202,240,.18);
    display:flex; flex-direction:column; overflow:hidden;
    transition:width .25s; z-index:10;
}
#sc-earth-sidebar.collapsed { width:0; }
#sc-sb-toggle {
    position:absolute; right:280px; top:50%; transform:translateY(-50%);
    z-index:30; background:rgba(13,202,240,.1);
    border:1px solid rgba(13,202,240,.25); border-right:none;
    border-radius:6px 0 0 6px; color:#0dcaf0;
    padding:8px 5px; cursor:pointer; line-height:1; transition:right .25s;
}
#sc-sb-toggle.collapsed {
    right:0; border-radius:0 6px 6px 0;
    border:1px solid rgba(13,202,240,.25); border-left:none;
}
#sc-earth-sidebar-scroll {
    flex:1; overflow-y:auto;
    scrollbar-width:thin; scrollbar-color:rgba(13,202,240,.2) transparent;
}
.sc-earth-section { padding:.65rem .9rem; border-bottom:1px solid rgba(255,255,255,.05); }
.sc-earth-section h6 {
    font-size:.65rem; font-weight:700; letter-spacing:1.2px;
    text-transform:uppercase; color:#6c757d; margin-bottom:.5rem;
}
.sc-stat-chip {
    display:inline-flex; flex-direction:column; align-items:center;
    background:rgba(13,202,240,.05); border:1px solid rgba(13,202,240,.12);
    border-radius:8px; padding:.28rem .55rem; min-width:52px;
}
.sc-stat-chip .val { font-size:.95rem; font-weight:700; color:#0dcaf0; line-height:1.1; }
.sc-stat-chip .lbl { font-size:.57rem; color:#6c757d; letter-spacing:.5px; text-transform:uppercase; }
.sc-ctrl-btn {
    background:rgba(13,202,240,.07); border:1px solid rgba(13,202,240,.2);
    border-radius:6px; color:#0dcaf0; padding:4px 9px; font-size:.76rem;
    cursor:pointer; transition:all .15s; white-space:nowrap; text-decoration:none;
}
.sc-ctrl-btn:hover  { background:rgba(13,202,240,.18); color:#0dcaf0; }
.sc-ctrl-btn.active { background:rgba(13,202,240,.22); box-shadow:0 0 8px rgba(13,202,240,.3); }
.sc-layer-btn {
    display:flex; align-items:center; gap:.5rem; width:100%;
    background:transparent; border:1px solid rgba(255,255,255,.07);
    border-radius:6px; color:#adb5bd; padding:.32rem .65rem;
    font-size:.78rem; cursor:pointer; transition:all .15s; text-align:left;
}
.sc-layer-btn:hover  { background:rgba(255,255,255,.04); }
.sc-layer-btn.active { border-color:rgba(13,202,240,.35); color:#e0e0e0; }
.sc-layer-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.lbadge { font-size:.63rem; padding:2px 7px; border-radius:100px; font-weight:600; letter-spacing:.4px; }
.lbadge.space    { background:rgba(192,212,255,.12); color:#c0d4ff; border:1px solid rgba(192,212,255,.25); }
.lbadge.internet { background:rgba(13,202,240,.1);   color:#0dcaf0; border:1px solid rgba(13,202,240,.25); }
.lbadge.human    { background:rgba(37,193,122,.12);  color:#25c17a; border:1px solid rgba(37,193,122,.25); }
.lbadge.ai       { background:rgba(255,193,7,.1);    color:#ffc107; border:1px solid rgba(255,193,7,.25);  }
.lbadge.physical { background:rgba(255,107,53,.12);  color:#ff6b35; border:1px solid rgba(255,107,53,.25); }
.lbadge.self     { background:rgba(167,139,250,.15); color:#a78bfa; border:1px solid rgba(167,139,250,.3); }
#sc-earth-search {
    width:100%; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.1);
    color:#e0e0e0; border-radius:6px; padding:.3rem .65rem; font-size:.8rem;
}
#sc-earth-search:focus { outline:none; border-color:rgba(13,202,240,.4); }
.sc-node-item {
    display:flex; align-items:center; gap:.45rem; padding:.28rem .35rem;
    border-radius:5px; cursor:pointer; font-size:.77rem; transition:background .1s;
}
.sc-node-item:hover { background:rgba(13,202,240,.07); }
.sc-node-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
#sc-earth-tooltip {
    position:fixed; pointer-events:none; background:rgba(5,8,22,.96);
    border:1px solid rgba(13,202,240,.35); color:#e0e0e0;
    padding:5px 11px; border-radius:7px; font-size:.76rem;
    z-index:9999; display:none; max-width:230px;
}
@keyframes sc-spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
.spin { animation:sc-spin .7s linear infinite; display:inline-block; }
.sc-leg-dot { width:9px; height:9px; border-radius:50%; display:inline-block; flex-shrink:0; }
</style>
<div id="sc-earth-page">
  <div id="sc-earth-topbar">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <span class="fw-bold" style="color:#0dcaf0;font-size:.9rem;"><i class="bi bi-globe2"></i> Earth Network</span>
      <div class="d-flex gap-2">
        <div class="sc-stat-chip"><span class="val" id="stat-total">&ndash;</span><span class="lbl">Nodes</span></div>
        <div class="sc-stat-chip"><span class="val" id="stat-links">&ndash;</span><span class="lbl">Links</span></div>
        <div class="sc-stat-chip"><span class="val" id="stat-sc">&ndash;</span><span class="lbl">SC Users</span></div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-1 flex-wrap">
      <button class="sc-ctrl-btn" id="btn-space">&#128752; Space</button>
      <button class="sc-ctrl-btn" id="btn-human">&#128101; Humans</button>
      <button class="sc-ctrl-btn" id="btn-internet">&#128279; Internet</button>
      <button class="sc-ctrl-btn" id="btn-physical">&#127970; Physical</button>
      <div style="width:1px;height:16px;background:rgba(255,255,255,.08);margin:0 2px;"></div>
      <button class="sc-ctrl-btn" id="btn-reset"><i class="bi bi-arrows-fullscreen"></i></button>
      <button class="sc-ctrl-btn active" id="btn-autorot"><i class="bi bi-arrow-repeat"></i></button>
      <button class="sc-ctrl-btn" id="btn-refresh"><i class="bi bi-arrow-clockwise" id="sc-refresh-icon"></i></button>
      <a href="{{ url_for('web.network') }}" class="sc-ctrl-btn"><i class="bi bi-diagram-3"></i> 2D</a>
    </div>
  </div>
  <div id="sc-earth-main">
    <div id="sc-earth-canvas-wrap">
      <div id="sc-earth-loading">
        <div class="spinner-border text-info" style="width:2rem;height:2rem;"></div>
        <span>Initializing Earth network&hellip;</span>
      </div>
    </div>
    <button id="sc-sb-toggle" title="Toggle panel"><i class="bi bi-layout-sidebar-reverse" id="sc-sb-icon"></i></button>
    <div id="sc-earth-sidebar">
      <div id="sc-earth-sidebar-scroll">
        <div class="sc-earth-section">
          <h6>Selected Node</h6>
          <div id="sc-nd-placeholder" class="text-secondary small d-flex align-items-center gap-1"><i class="bi bi-cursor"></i> Click a node to inspect</div>
          <div id="sc-nd-content" class="d-none">
            <div class="d-flex align-items-start gap-2 mb-2">
              <div id="sc-nd-icon" style="font-size:1.5rem;line-height:1;flex-shrink:0;"></div>
              <div style="min-width:0;flex:1;">
                <div class="fw-bold text-light text-truncate" id="sc-nd-name" style="font-size:.88rem;"></div>
                <div id="sc-nd-badges" class="d-flex gap-1 flex-wrap mt-1"></div>
              </div>
            </div>
            <div class="text-secondary mb-2" style="font-size:.65rem;word-break:break-all;" id="sc-nd-did"></div>
            <div id="sc-nd-meta" class="mb-2" style="font-size:.72rem;"></div>
            <div class="d-flex gap-2">
              <button class="sc-ctrl-btn" id="sc-nd-focus" style="font-size:.72rem;"><i class="bi bi-camera"></i> Focus</button>
              <button class="sc-ctrl-btn" id="sc-nd-chat"  style="font-size:.72rem;"><i class="bi bi-chat-dots"></i> Chat</button>
            </div>
          </div>
        </div>
        <div class="sc-earth-section">
          <h6>Search Nodes</h6>
          <input type="text" id="sc-earth-search" placeholder="Name, type, layer, DID&hellip;" autocomplete="off">
          <div id="sc-search-results" class="mt-2" style="max-height:190px;overflow-y:auto;"></div>
        </div>
        <div class="sc-earth-section">
          <h6>Layers</h6>
          <div class="d-flex flex-column gap-1">
            <button class="sc-layer-btn active" data-layer="space"><span class="sc-layer-dot" style="background:#c0d4ff;box-shadow:0 0 4px #c0d4ff90;"></span><span style="flex:1;">Space Assets</span><span class="badge bg-secondary" id="lc-space">&ndash;</span></button>
            <button class="sc-layer-btn active" data-layer="human"><span class="sc-layer-dot" style="background:#25c17a;box-shadow:0 0 4px #25c17a90;"></span><span style="flex:1;">Humans &amp; AI</span><span class="badge bg-secondary" id="lc-human">&ndash;</span></button>
            <button class="sc-layer-btn active" data-layer="internet"><span class="sc-layer-dot" style="background:#0dcaf0;box-shadow:0 0 4px #0dcaf090;"></span><span style="flex:1;">Internet</span><span class="badge bg-secondary" id="lc-internet">&ndash;</span></button>
            <button class="sc-layer-btn active" data-layer="physical"><span class="sc-layer-dot" style="background:#ff6b35;box-shadow:0 0 4px #ff6b3590;"></span><span style="flex:1;">Physical Assets</span><span class="badge bg-secondary" id="lc-physical">&ndash;</span></button>
          </div>
        </div>
        <div class="sc-earth-section">
          <h6>Legend</h6>
          <div class="d-flex flex-column gap-2" style="font-size:.77rem;">
            <div class="d-flex align-items-center gap-2"><span class="sc-leg-dot" style="background:#c0d4ff;box-shadow:0 0 4px #c0d4ff;"></span><span class="text-secondary">Satellites / Space Assets</span></div>
            <div class="d-flex align-items-center gap-2"><span class="sc-leg-dot" style="background:#25c17a;box-shadow:0 0 4px #25c17a;"></span><span class="text-secondary">Human SC Nodes</span></div>
            <div class="d-flex align-items-center gap-2"><span class="sc-leg-dot" style="background:#ffc107;box-shadow:0 0 4px #ffc107;"></span><span class="text-secondary">AI Agents</span></div>
            <div class="d-flex align-items-center gap-2"><span class="sc-leg-dot" style="background:#a78bfa;box-shadow:0 0 4px #a78bfa;"></span><span class="text-secondary">You (active user)</span></div>
            <div class="d-flex align-items-center gap-2"><span class="sc-leg-dot" style="background:#0dcaf0;box-shadow:0 0 4px #0dcaf0;"></span><span class="text-secondary">Internet Infrastructure</span></div>
            <div class="d-flex align-items-center gap-2"><span class="sc-leg-dot" style="background:#ff6b35;box-shadow:0 0 4px #ff6b35;"></span><span class="text-secondary">Physical / Earth Assets</span></div>
          </div>
        </div>
        <div class="sc-earth-section">
          <h6>SC Nodes <span class="badge bg-secondary ms-1" id="sc-node-badge">0</span></h6>
          <div id="sc-nodes-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="sc-earth-tooltip"></div>
{% endblock %}
{% block scripts %}
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
const USER_DID = {{ user_did | tojson }};
const USERNAME = {{ username | tojson }};
const EARTH_R  = 1.2;
const LAYER = {
    physical: { r:1.78, color:0xff6b35, emGain:0.28, nodeSize:0.055 },
    internet: { r:2.55, color:0x0dcaf0, emGain:0.22, nodeSize:0.038 },
    human:    { r:3.50, color:0x25c17a, emGain:0.25, nodeSize:0.060 },
    space:    { r:5.20, color:0xc0d4ff, emGain:0.20, nodeSize:0.065 },
};
const AI_COL=0xffc107, SELF_COL=0xa78bfa;
let scene,camera,renderer,controls,earthMesh,cloudMesh,atmMesh,raycaster,mouse;
let layerGroups={},layerVisible={space:true,human:true,internet:true,physical:true};
let allNodes=[],allMeshes=[],connLines=null,connLineGroups=[],scNodes=[],autoRot=true,hoverNd=null;
const clock=new THREE.Clock();
function init(){
    const wrap=document.getElementById('sc-earth-canvas-wrap');
    renderer=new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
    renderer.setSize(wrap.clientWidth,wrap.clientHeight);
    wrap.appendChild(renderer.domElement);
    scene=new THREE.Scene();
    scene.background=new THREE.Color(0x00000a);
    scene.fog=new THREE.FogExp2(0x00000a,0.016);
    camera=new THREE.PerspectiveCamera(52,wrap.clientWidth/wrap.clientHeight,0.05,600);
    camera.position.set(0,3,11);
    controls=new OrbitControls(camera,renderer.domElement);
    controls.enableDamping=true;controls.dampingFactor=0.06;controls.rotateSpeed=0.5;controls.zoomSpeed=0.8;
    controls.minDistance=EARTH_R*1.3;controls.maxDistance=40;controls.autoRotate=true;controls.autoRotateSpeed=0.12;
    raycaster=new THREE.Raycaster();mouse=new THREE.Vector2();
    buildStars();buildEarth();
    Object.keys(LAYER).forEach(k=>{layerGroups[k]=new THREE.Group();scene.add(layerGroups[k]);});
    renderer.domElement.addEventListener('mousemove',onMouseMove);
    renderer.domElement.addEventListener('click',onClick);
    window.addEventListener('resize',onResize);
    requestAnimationFrame(animate);
}
function buildStars(){
    const N=5000,pos=new Float32Array(N*3),col=new Float32Array(N*3);
    const starColors=[[1,1,1],[.8,.9,1],[1,.95,.85],[.7,.8,1],[1,.85,.7]];
    for(let i=0;i<N;i++){const phi=Math.acos(2*Math.random()-1),t=Math.random()*Math.PI*2,r=85+Math.random()*140;pos[i*3]=r*Math.sin(phi)*Math.cos(t);pos[i*3+1]=r*Math.sin(phi)*Math.sin(t);pos[i*3+2]=r*Math.cos(phi);const sc=starColors[Math.floor(Math.random()*starColors.length)];col[i*3]=sc[0];col[i*3+1]=sc[1];col[i*3+2]=sc[2];}
    const geo=new THREE.BufferGeometry();geo.setAttribute('position',new THREE.BufferAttribute(pos,3));geo.setAttribute('color',new THREE.BufferAttribute(col,3));
    scene.add(new THREE.Points(geo,new THREE.PointsMaterial({size:0.10,sizeAttenuation:true,transparent:true,opacity:0.80,vertexColors:true})));
}
function buildEarth(){
    const texW=1024,texH=512,cv=document.createElement('canvas');cv.width=texW;cv.height=texH;
    const cx=cv.getContext('2d');
    const grad=cx.createLinearGradient(0,0,0,texH);
    grad.addColorStop(0,'#071532');grad.addColorStop(.45,'#0d2f6b');grad.addColorStop(.55,'#0d2f6b');grad.addColorStop(1,'#071532');
    cx.fillStyle=grad;cx.fillRect(0,0,texW,texH);
    function blob(x,y,w,h,col,a){
        cx.save();cx.globalAlpha=a;cx.fillStyle=col;cx.beginPath();
        cx.moveTo(x+w*.5,y);cx.bezierCurveTo(x+w*.92,y+h*.08,x+w,y+h*.42,x+w*.88,y+h*.72);
        cx.bezierCurveTo(x+w*.72,y+h,x+w*.28,y+h*.96,x+w*.08,y+h*.74);
        cx.bezierCurveTo(x-w*.04,y+h*.52,x+w*.04,y+h*.18,x+w*.5,y);
        cx.closePath();cx.fill();cx.restore();
    }
    blob(165,68,105,215,'#2b6e3f',.85);blob(195,265,72,140,'#2b6e3f',.80);blob(158,155,44,88,'#8a6318',.70);
    blob(470,62,82,108,'#2b6e3f',.80);blob(480,148,92,192,'#8a6318',.78);blob(495,318,72,84,'#2b6e3f',.72);
    blob(575,44,215,155,'#2b6e3f',.82);blob(680,55,105,105,'#5a4830',.65);blob(595,175,118,82,'#8a6318',.72);
    blob(718,288,94,72,'#8a6318',.76);blob(705,282,42,44,'#2b6e3f',.70);
    cx.fillStyle='#c8e4f0';cx.globalAlpha=.72;cx.fillRect(0,0,texW,20);cx.fillRect(0,texH-22,texW,22);
    blob(190,0,85,50,'#b0d8e8',.65);
    cx.strokeStyle='rgba(80,160,255,0.07)';cx.lineWidth=.6;
    for(let x=0;x<texW;x+=texW/12){cx.beginPath();cx.moveTo(x,0);cx.lineTo(x,texH);cx.stroke();}
    for(let y=0;y<texH;y+=texH/6){cx.beginPath();cx.moveTo(0,y);cx.lineTo(texW,y);cx.stroke();}
    cx.globalAlpha=.42;cx.fillStyle='#ffe090';
    // Major city lights across continents
    [[215,95],[490,75],[520,88],[600,76],[640,78],[488,158],[502,198],[218,268],[722,293],
     [175,115],[225,135],[300,90],[350,80],[420,100],[560,120],[610,140],[670,160],[190,200],
     [240,185],[370,175],[445,185],[515,210],[565,230],[620,220],[700,200],[760,250],
     [200,270],[280,265],[340,250],[480,260],[530,285],[590,310],[650,280],[730,310]
    ].forEach(([x,y])=>{cx.beginPath();cx.arc(x,y,2.5,0,Math.PI*2);cx.fill();});
    cx.globalAlpha=1;
    earthMesh=new THREE.Mesh(new THREE.SphereGeometry(EARTH_R,64,32),new THREE.MeshPhongMaterial({map:new THREE.CanvasTexture(cv),specular:new THREE.Color(0x1a4a8a),shininess:22,emissive:new THREE.Color(0x050a14),emissiveIntensity:0.35}));
    scene.add(earthMesh);
    const ccv=document.createElement('canvas');ccv.width=512;ccv.height=256;const ccx=ccv.getContext('2d');
    for(let i=0;i<65;i++){ccx.globalAlpha=Math.random()*.28+.08;ccx.fillStyle='rgba(255,255,255,.55)';ccx.beginPath();ccx.ellipse(Math.random()*512,Math.random()*256,Math.random()*32+6,Math.random()*16+4,Math.random()*Math.PI,0,Math.PI*2);ccx.fill();}
    cloudMesh=new THREE.Mesh(new THREE.SphereGeometry(EARTH_R*1.008,48,24),new THREE.MeshPhongMaterial({map:new THREE.CanvasTexture(ccv),transparent:true,opacity:0.38,depthWrite:false}));
    scene.add(cloudMesh);
    atmMesh=new THREE.Mesh(new THREE.SphereGeometry(EARTH_R*1.12,32,16),new THREE.ShaderMaterial({
        vertexShader:'varying vec3 vN;void main(){vN=normalize(normalMatrix*normal);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}',
        fragmentShader:'varying vec3 vN;void main(){float i=pow(.68-dot(vN,vec3(0.,0.,1.)),2.8);gl_FragColor=vec4(.10,.55,1.,clamp(i*1.1,0.,1.));}',
        side:THREE.FrontSide,blending:THREE.AdditiveBlending,transparent:true,depthWrite:false}));
    scene.add(atmMesh);
    const sun=new THREE.DirectionalLight(0xfff0d8,1.9);sun.position.set(12,6,9);scene.add(sun);
    scene.add(new THREE.AmbientLight(0x0a0a1c,.65));
}
function fibSphere(n,r,j=.06){
    const phi=Math.PI*(3-Math.sqrt(5));
    return Array.from({length:n},(_,i)=>{
        const y=(1-(i/Math.max(n-1,1))*2)*r,rad=Math.sqrt(Math.max(0,r*r-y*y)),t=phi*i;
        return new THREE.Vector3(Math.cos(t)*rad+(Math.random()-.5)*j*r,y+(Math.random()-.5)*j*r,Math.sin(t)*rad+(Math.random()-.5)*j*r);
    });
}
function makeNodeMesh(layer,color,size){
    let geo;
    switch(layer){case 'space':geo=new THREE.OctahedronGeometry(size,0);break;case 'internet':geo=new THREE.BoxGeometry(size,size,size);break;case 'physical':geo=new THREE.DodecahedronGeometry(size,0);break;default:geo=new THREE.SphereGeometry(size,10,5);break;}
    const c=new THREE.Color(color);
    const mesh=new THREE.Mesh(geo,new THREE.MeshPhongMaterial({color:c,emissive:c.clone().multiplyScalar(LAYER[layer]?.emGain||.2),shininess:70,transparent:true,opacity:.9}));
    const glow=new THREE.Sprite(new THREE.SpriteMaterial({color:c,transparent:true,opacity:.22,sizeAttenuation:true,blending:THREE.AdditiveBlending,depthWrite:false}));
    glow.scale.setScalar(size*10);mesh.add(glow);return mesh;
}
function buildAllNodes(scData){
    allNodes=[];allMeshes=[];Object.values(layerGroups).forEach(g=>{while(g.children.length)g.remove(g.children[0]);});
    connLineGroups.forEach(l=>{if(l)scene.remove(l);});connLineGroups=[];
    if(connLines){scene.remove(connLines);connLines=null;}
    const spaceList=[
        {icon:'\u{1F6F0}',name:'GPS Constellation',sub:'Navigation'},
        {icon:'\u{1F4E1}',name:'Starlink Swarm',sub:'Broadband'},
        {icon:'\u{1F6F8}',name:'ISS',sub:'Space Station'},
        {icon:'\u{1F52D}',name:'James Webb Telescope',sub:'Science'},
        {icon:'\u{1F4E1}',name:'Intelsat-39',sub:'Comms'},
        {icon:'\u{1F6F0}',name:'GOES-18 Weather Sat',sub:'Meteorology'},
        {icon:'\u{1F4E1}',name:'Iridium Next',sub:'IoT/Mobile'},
        {icon:'\u{1F6F8}',name:'Tiangong Station',sub:'Space Station'},
        {icon:'\u{1F6F0}',name:'OneWeb Cluster',sub:'Broadband'},
        {icon:'\u{1F52D}',name:'Hubble Telescope',sub:'Science'},
        {icon:'\u{1F4E1}',name:'DirecTV Satellite',sub:'Broadcasting'},
        {icon:'\u{1F6F0}',name:'Landsat 9',sub:'Earth Obs.'},
        {icon:'\u{1F4E1}',name:'Inmarsat Node',sub:'Maritime'},
        {icon:'\u{1F6F0}',name:'NOAA-21',sub:'Weather'},
        {icon:'\u{1F6F0}',name:'SES Satellite',sub:'Broadcasting'},
        {icon:'\u{1F6F0}',name:'Sentinel-2A',sub:'Earth Obs.'},
        {icon:'\u{1F4E1}',name:'Military Comsat',sub:'Defense'},
        {icon:'\u{1F6F0}',name:'Aqua Satellite',sub:'Science'},
    ];
    const sPos=fibSphere(spaceList.length,LAYER.space.r,.14);
    spaceList.forEach((s,i)=>{const nd={id:'space_'+i,layer:'space',type:'satellite',icon:s.icon,name:s.name,sub:s.sub,pos:sPos[i].clone()};const m=makeNodeMesh('space',LAYER.space.color,LAYER.space.nodeSize*1.3);m.position.copy(nd.pos);m.userData=nd;layerGroups.space.add(m);allNodes.push(nd);allMeshes.push({mesh:m,nd});});
    const iT=['BGP Router','CDN Node','Internet Exchange','Fiber Hub','DNS Server','Edge Node','Core Switch','Peering Point','Cloud Node','Cache Server','Load Balancer','API Gateway','SDN Controller','Network Relay','Anycast Node'];
    const INET_N=185,iPos=fibSphere(INET_N,LAYER.internet.r,.07);
    for(let i=0;i<INET_N;i++){const t=iT[i%iT.length];const nd={id:'inet_'+i,layer:'internet',type:'infrastructure',icon:'\u{1F517}',name:t+' '+(i+1),sub:t,pos:iPos[i].clone()};const m=makeNodeMesh('internet',LAYER.internet.color,LAYER.internet.nodeSize);m.position.copy(nd.pos);m.userData=nd;layerGroups.internet.add(m);allNodes.push(nd);allMeshes.push({mesh:m,nd});}
    const physList=[
        {icon:'\u{1F3E2}',name:'AWS Data Center',sub:'Cloud'},{icon:'\u{1F3E2}',name:'Azure Data Center',sub:'Cloud'},
        {icon:'\u{1F3E2}',name:'Google Cloud DC',sub:'Cloud'},{icon:'\u{1F3E2}',name:'Meta Data Center',sub:'Cloud'},
        {icon:'\u{1F3ED}',name:'Smart Factory Alpha',sub:'Industry 4.0'},{icon:'\u{1F3ED}',name:'Smart Factory Beta',sub:'Industry 4.0'},
        {icon:'\u{1F306}',name:'New York IoT Hub',sub:'Smart City'},{icon:'\u{1F306}',name:'London IoT Hub',sub:'Smart City'},
        {icon:'\u{1F306}',name:'Tokyo IoT Hub',sub:'Smart City'},{icon:'\u{1F306}',name:'Shanghai IoT Hub',sub:'Smart City'},
        {icon:'\u{1F306}',name:'Mumbai IoT Hub',sub:'Smart City'},{icon:'\u{1F306}',name:'São Paulo IoT Hub',sub:'Smart City'},
        {icon:'\u{1F916}',name:'Industrial Robot Fleet',sub:'Automation'},{icon:'\u{1F916}',name:'Warehouse Robots',sub:'Logistics'},
        {icon:'\u{1F697}',name:'Connected Vehicle Hub',sub:'Transport IoT'},{icon:'\u{1F682}',name:'Rail IoT Network',sub:'Transport'},
        {icon:'\u2708',name:'Airport IoT Grid',sub:'Transport'},{icon:'\u{1F3E5}',name:'Smart Hospital Network',sub:'Healthcare IoT'},
        {icon:'\u26A1',name:'Power Grid Node',sub:'Energy Grid'},{icon:'\u26A1',name:'Renewable Energy Hub',sub:'Energy'},
        {icon:'\u{1F331}',name:'Smart Farm Network',sub:'AgriTech'},{icon:'\u{1F30A}',name:'Ocean Sensor Array',sub:'Environmental'},
        {icon:'\u{1F30D}',name:'Weather Station Net',sub:'Environmental'},{icon:'\u{1F3D7}',name:'Construction AI Hub',sub:'Heavy Machinery'},
        {icon:'\u{1F4F1}',name:'IoT Gateway Cluster',sub:'Smart Devices'},{icon:'\u{1F3E0}',name:'Smart Home Hubs',sub:'Home Automation'},
        {icon:'\u{1F681}',name:'Drone Fleet Hub',sub:'Unmanned Systems'},{icon:'\u{1F6E2}',name:'Industrial Plant',sub:'Resource'},
        {icon:'\u{1F4E1}',name:'Ground Station Net',sub:'Communication'},{icon:'\u{1F3E6}',name:'Financial Network Hub',sub:'FinTech'},
    ];
    const pPos=fibSphere(physList.length,LAYER.physical.r,.12);
    physList.forEach((p,i)=>{const nd={id:'phys_'+i,layer:'physical',type:'physical',icon:p.icon,name:p.name,sub:p.sub,pos:pPos[i].clone()};const m=makeNodeMesh('physical',LAYER.physical.color,LAYER.physical.nodeSize*1.25);m.position.copy(nd.pos);m.userData=nd;layerGroups.physical.add(m);allNodes.push(nd);allMeshes.push({mesh:m,nd});});
    const humanR=LAYER.human.r,toPlace=scData.length?scData:[{did:USER_DID,username:USERNAME||'You',is_agent:false,metadata:{}}];
    const hPos=fibSphere(toPlace.length,humanR,.20);
    toPlace.forEach((n,i)=>{
        const isSelf=n.did===USER_DID,isAgent=!!n.is_agent,col=isSelf?SELF_COL:(isAgent?AI_COL:LAYER.human.color);
        const nd={id:n.did,layer:'human',type:isSelf?'self':(isAgent?'ai':'human'),icon:isSelf?'\u{1F7E3}':(isAgent?'\u{1F916}':'\u{1F464}'),name:n.username||n.did.slice(-10),sub:isAgent?'AI Agent':'SC User',did:n.did,metadata:n.metadata||{},pos:(hPos[i]||new THREE.Vector3(0,humanR,0)).clone()};
        const sz=LAYER.human.nodeSize*(isSelf?1.9:isAgent?1.5:1.15);const m=makeNodeMesh('human',col,sz);m.position.copy(nd.pos);m.userData=nd;layerGroups.human.add(m);allNodes.push(nd);allMeshes.push({mesh:m,nd});
    });
    buildConnections();updateStats();renderNodesList();
}
function buildConnections(){
    // Per-layer colored segment arrays: [segments, hex color, opacity]
    const phy=[], inet=[], hum=[], spc=[], cross=[];
    const pNd=allNodes.filter(n=>n.layer==='physical');
    const iNd=allNodes.filter(n=>n.layer==='internet');
    const hNd=allNodes.filter(n=>n.layer==='human');
    const sNd=allNodes.filter(n=>n.layer==='space');
    function nearLinks(src,dest,maxPeers,maxDist){src.forEach(a=>{src.filter(b=>b!==a).map(b=>({b,d:a.pos.distanceTo(b.pos)})).filter(({d})=>d<maxDist).sort((x,y)=>x.d-y.d).slice(0,maxPeers).forEach(({b})=>dest.push(a.pos.x,a.pos.y,a.pos.z,b.pos.x,b.pos.y,b.pos.z));});}
    nearLinks(pNd,phy,3,2.8);
    nearLinks(iNd,inet,7,1.9); // dense internet mesh
    nearLinks(sNd,spc,2,5.5);
    hNd.forEach((a,i)=>{hNd.slice(i+1).filter(()=>Math.random()<.35).slice(0,3).forEach(b=>hum.push(a.pos.x,a.pos.y,a.pos.z,b.pos.x,b.pos.y,b.pos.z));});
    // Cross-layer: physical↔internet, internet↔human, space↔physical
    pNd.forEach(p=>{iNd.filter(()=>Math.random()<.12).slice(0,2).forEach(q=>cross.push(p.pos.x,p.pos.y,p.pos.z,q.pos.x,q.pos.y,q.pos.z));});
    iNd.forEach(p=>{hNd.filter(()=>Math.random()<.06).slice(0,2).forEach(q=>cross.push(p.pos.x,p.pos.y,p.pos.z,q.pos.x,q.pos.y,q.pos.z));});
    sNd.forEach(s=>{pNd.filter(()=>Math.random()<.20).slice(0,2).forEach(p=>cross.push(s.pos.x,s.pos.y,s.pos.z,p.pos.x,p.pos.y,p.pos.z));});
    const layers2=[{segs:phy,color:0xff6b35,opacity:.14},{segs:inet,color:0x0dcaf0,opacity:.09},{segs:hum,color:0x25c17a,opacity:.18},{segs:spc,color:0xc0d4ff,opacity:.13},{segs:cross,color:0x4488cc,opacity:.06}];
    let totalLinks=0;
    connLineGroups=layers2.map(({segs,color,opacity})=>{
        if(!segs.length)return null;
        totalLinks+=segs.length/6;
        const geo=new THREE.BufferGeometry();geo.setAttribute('position',new THREE.Float32BufferAttribute(segs,3));
        const ls=new THREE.LineSegments(geo,new THREE.LineBasicMaterial({color,transparent:true,opacity,blending:THREE.AdditiveBlending,depthWrite:false}));
        scene.add(ls);return ls;
    }).filter(Boolean);
    connLines=connLineGroups[0]||null;
    document.getElementById('stat-links').textContent=Math.round(totalLinks);
}
function updateStats(){
    document.getElementById('stat-total').textContent=allNodes.length;document.getElementById('stat-sc').textContent=allNodes.filter(n=>n.layer==='human').length;
    ['space','internet','human','physical'].forEach(l=>{const el=document.getElementById('lc-'+l);if(el)el.textContent=allNodes.filter(n=>n.layer===l).length;});
}
function renderNodesList(){
    const hNd=allNodes.filter(n=>n.layer==='human');document.getElementById('sc-node-badge').textContent=hNd.length;
    const list=document.getElementById('sc-nodes-list');
    list.innerHTML=hNd.map(n=>{const col=n.type==='self'?'#a78bfa':n.type==='ai'?'#ffc107':'#25c17a';return '<div class="sc-node-item" data-nid="'+escH(n.id)+'"><span class="sc-node-dot" style="background:'+col+';box-shadow:0 0 4px '+col+';"></span><span class="text-light text-truncate" style="flex:1;max-width:155px;">'+n.icon+' '+escH(n.name)+'</span><span class="text-secondary" style="font-size:.64rem;">'+escH(n.sub)+'</span></div>';}).join('');
    list.querySelectorAll('[data-nid]').forEach(el=>{el.addEventListener('click',()=>{const nd=allNodes.find(n=>n.id===el.dataset.nid);if(nd)focusNode(nd);});});
}
function onMouseMove(e){
    const rect=renderer.domElement.getBoundingClientRect();
    mouse.x=((e.clientX-rect.left)/rect.width)*2-1;mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
    raycaster.setFromCamera(mouse,camera);
    const hits=raycaster.intersectObjects(allMeshes.filter(({nd})=>layerVisible[nd.layer]).map(({mesh})=>mesh),true);
    const tt=document.getElementById('sc-earth-tooltip');
    if(hits.length){let obj=hits[0].object;while(obj&&!obj.userData.id&&obj.parent)obj=obj.parent;
        if(obj&&obj.userData.id){hoverNd=obj.userData;const nd=hoverNd;
            tt.innerHTML='<div style="font-weight:700;">'+nd.icon+' '+escH(nd.name)+'</div><div style="color:#6c757d;font-size:.7rem;">'+escH(nd.sub||nd.layer)+' &middot; '+escH(nd.layer)+'</div>'+(nd.did?'<div style="color:#ffc107;font-size:.63rem;margin-top:2px;">'+escH(nd.did.slice(0,22))+'&hellip;</div>':'');
            tt.style.display='block';tt.style.left=(e.clientX+14)+'px';tt.style.top=(e.clientY-8)+'px';renderer.domElement.style.cursor='pointer';}}
    else{hoverNd=null;tt.style.display='none';renderer.domElement.style.cursor='default';}
}
function onClick(){if(hoverNd)showNodeDetail(hoverNd);}
function showNodeDetail(nd){
    document.getElementById('sc-nd-placeholder').classList.add('d-none');document.getElementById('sc-nd-content').classList.remove('d-none');
    document.getElementById('sc-nd-icon').textContent=nd.icon||'\u25CF';document.getElementById('sc-nd-name').textContent=nd.name||nd.id;document.getElementById('sc-nd-did').textContent=nd.did||nd.id||'';
    const lKey=nd.type==='ai'?'ai':nd.type==='self'?'self':nd.layer;const lLabel={space:'Space',internet:'Internet',human:'Human',physical:'Physical',ai:'AI Agent',self:'You'};
    document.getElementById('sc-nd-badges').innerHTML='<span class="lbadge '+lKey+'">'+(lLabel[lKey]||nd.layer)+'</span>'+(nd.type==='self'?'<span class="lbadge self" style="margin-left:3px;">Active User</span>':'');
    const rows=Object.entries(nd.metadata||{}).filter(([k])=>k!=='external_contacts');
    document.getElementById('sc-nd-meta').innerHTML=rows.length?'<table style="width:100%;font-size:.7rem;">'+rows.map(([k,v])=>'<tr><td class="text-secondary pe-2">'+escH(k)+'</td><td class="text-light">'+escH(String(v))+'</td></tr>').join('')+'</table>':'';
    document.getElementById('sc-nd-focus').onclick=()=>focusNode(nd);document.getElementById('sc-nd-chat').onclick=()=>prefillChat(nd);
}
function focusNode(nd){if(!nd.pos)return;animateCam(nd.pos.clone().normalize().multiplyScalar(nd.pos.length()*2.4),nd.pos);}
function jumpToLayer(key){const r=LAYER[key]?.r||5;animateCam(new THREE.Vector3(r*1.8,r*.7,r*1.5),new THREE.Vector3(0,0,0));}
function animateCam(tPos,tLook){
    const sPos=camera.position.clone(),sLook=controls.target.clone(),dur=900,t0=performance.now();
    controls.autoRotate=false;
    (function step(now){const t=Math.min((now-t0)/dur,1),e=t<.5?2*t*t:-1+(4-2*t)*t;camera.position.lerpVectors(sPos,tPos,e);controls.target.lerpVectors(sLook,tLook,e);controls.update();if(t<1)requestAnimationFrame(step);else if(autoRot)controls.autoRotate=true;})(t0);
}
document.getElementById('sc-earth-search').addEventListener('input',function(){
    const q=this.value.trim().toLowerCase(),res=document.getElementById('sc-search-results');
    if(!q){res.innerHTML='';return;}
    const hits=allNodes.filter(n=>n.name.toLowerCase().includes(q)||(n.sub||'').toLowerCase().includes(q)||(n.did||'').toLowerCase().includes(q)||n.layer.toLowerCase().includes(q)).slice(0,14);
    const COLS={space:'#c0d4ff',internet:'#0dcaf0',physical:'#ff6b35',human:'#25c17a',ai:'#ffc107',self:'#a78bfa'};
    res.innerHTML=hits.map(n=>{const c=n.type==='ai'?COLS.ai:n.type==='self'?COLS.self:COLS[n.layer]||'#adb5bd';return '<div class="sc-node-item" data-sid="'+escH(n.id)+'"><span class="sc-node-dot" style="background:'+c+';box-shadow:0 0 3px '+c+';"></span><div style="flex:1;min-width:0;"><div class="text-light text-truncate">'+n.icon+' '+escH(n.name)+'</div><div class="text-secondary" style="font-size:.65rem;">'+escH(n.layer)+' &middot; '+escH(n.sub||'')+'</div></div></div>';}).join('');
    res.querySelectorAll('[data-sid]').forEach(el=>{el.addEventListener('click',()=>{const nd=allNodes.find(n=>n.id===el.dataset.sid);if(nd){showNodeDetail(nd);focusNode(nd);}});});
});
document.querySelectorAll('.sc-layer-btn').forEach(btn=>{btn.addEventListener('click',()=>{const l=btn.dataset.layer;layerVisible[l]=!layerVisible[l];btn.classList.toggle('active',layerVisible[l]);layerGroups[l].visible=layerVisible[l];});});
document.getElementById('btn-space').addEventListener('click',()=>jumpToLayer('space'));
document.getElementById('btn-human').addEventListener('click',()=>jumpToLayer('human'));
document.getElementById('btn-internet').addEventListener('click',()=>jumpToLayer('internet'));
document.getElementById('btn-physical').addEventListener('click',()=>jumpToLayer('physical'));
document.getElementById('btn-reset').addEventListener('click',()=>{autoRot=true;controls.autoRotate=true;animateCam(new THREE.Vector3(0,3,11),new THREE.Vector3(0,0,0));});
document.getElementById('btn-autorot').addEventListener('click',function(){autoRot=!autoRot;controls.autoRotate=autoRot;this.classList.toggle('active',autoRot);});
document.getElementById('btn-refresh').addEventListener('click',loadData);
const sbBtn=document.getElementById('sc-sb-toggle');
sbBtn.addEventListener('click',()=>{const col=document.getElementById('sc-earth-sidebar').classList.toggle('collapsed');sbBtn.classList.toggle('collapsed',col);document.getElementById('sc-sb-icon').className=col?'bi bi-layout-sidebar':'bi bi-layout-sidebar-reverse';sbBtn.style.right=col?'0':'280px';});
function prefillChat(nd){const inp=document.getElementById('sc-chat-input');if(!inp)return;inp.value='Tell me about '+nd.name+' ('+( nd.sub||nd.layer)+')';inp.focus();const panel=document.getElementById('sc-chat-panel');if(panel&&!panel.classList.contains('open')&&typeof scToggleChat==='function')scToggleChat();}
function handleVizCommand(msg){const m=msg.toLowerCase();
    // Layer navigation
    if(m.match(/\bsatellite|space\s*layer|space\s*asset|orbit/)){jumpToLayer('space');return true;}
    if(m.match(/\bphysical|building|factory|data\s*center|robot|smart\s*city|iot|infrastructure\s*layer/)){jumpToLayer('physical');return true;}
    if(m.match(/\binternet|router|cdn|fiber|backbone|network\s*layer/)){jumpToLayer('internet');return true;}
    if(m.match(/\bhuman|user|agent|people|blockchain\s*user/)){jumpToLayer('human');return true;}
    // Camera controls
    if(m.match(/\breset|overview|full\s*view|zoom\s*out|earth\s*view/)){animateCam(new THREE.Vector3(0,3,11),new THREE.Vector3(0,0,0));return true;}
    if(m.match(/\bspin|auto.?rot|rotate\s*on/)){autoRot=true;controls.autoRotate=true;document.getElementById('btn-autorot').classList.add('active');return true;}
    if(m.match(/\bstop\s*spin|stop\s*rot|freeze/)){autoRot=false;controls.autoRotate=false;document.getElementById('btn-autorot').classList.remove('active');return true;}
    // Layer visibility toggle
    if(m.match(/\bhide\s+space|toggle\s+space/)){const b=document.querySelector('[data-layer="space"]');if(b)b.click();return true;}
    if(m.match(/\bhide\s+internet|toggle\s+internet/)){const b=document.querySelector('[data-layer="internet"]');if(b)b.click();return true;}
    if(m.match(/\bhide\s+physical|toggle\s+physical/)){const b=document.querySelector('[data-layer="physical"]');if(b)b.click();return true;}
    if(m.match(/\bhide\s+human|toggle\s+human/)){const b=document.querySelector('[data-layer="human"]');if(b)b.click();return true;}
    // Node search
    const fm=m.match(/(?:find|locate|zoom\s+to|show|focus\s+on?)\s+(.+)/);
    if(fm){const q=fm[1].trim();const nd=allNodes.find(n=>n.name.toLowerCase().includes(q)||(n.sub||'').toLowerCase().includes(q)||(n.did||'').toLowerCase().includes(q)||(n.type||'').toLowerCase().includes(q));if(nd){focusNode(nd);showNodeDetail(nd);return true;}}
    // Refresh
    if(m.match(/\brefresh|reload|update\s*data/)){loadData();return true;}
    return false;
}
window._scEarthVizCommand=handleVizCommand;
document.addEventListener('DOMContentLoaded',()=>{const inp=document.getElementById('sc-chat-input');if(!inp)return;inp.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey&&inp.value.trim())handleVizCommand(inp.value.trim());});document.getElementById('sc-chat-send-btn')?.addEventListener('click',()=>{if(inp.value.trim())handleVizCommand(inp.value.trim());},{capture:true});});
async function loadData(){
    document.getElementById('sc-refresh-icon').classList.add('spin');
    try{
        const [profRes,mapRes]=await Promise.all([fetch('/api/social/profiles'),fetch('/api/social/map')]);
        let profiles=[];if(profRes.ok){const d=await profRes.json();profiles=d.profiles||[];}
        const adjMap={};if(mapRes.ok){const d=await mapRes.json();Object.assign(adjMap,d.map||{});}
        const profByDid={};profiles.forEach(p=>{profByDid[p.did]=p;});
        const nodeSet=new Set(Object.keys(adjMap));nodeSet.add(USER_DID);
        scNodes=[...nodeSet].map(did=>{const p=profByDid[did]||{};return {did,username:p.display_name||p.username||did.slice(-10),is_agent:p.device_type==='agent',metadata:p.metadata||{}};});
        buildAllNodes(scNodes);
    }catch(e){console.warn('[EarthNet] load error:',e);buildAllNodes([]);}
    finally{document.getElementById('sc-refresh-icon').classList.remove('spin');const ld=document.getElementById('sc-earth-loading');ld.classList.add('hidden');setTimeout(()=>{ld.style.display='none';},600);}
}
function onResize(){const wrap=document.getElementById('sc-earth-canvas-wrap');renderer.setSize(wrap.clientWidth,wrap.clientHeight);camera.aspect=wrap.clientWidth/wrap.clientHeight;camera.updateProjectionMatrix();}
function animate(){requestAnimationFrame(animate);const t=clock.getElapsedTime();if(earthMesh)earthMesh.rotation.y=t*.04;if(cloudMesh)cloudMesh.rotation.y=t*.048;if(atmMesh)atmMesh.rotation.y=t*.032;if(layerGroups.space)layerGroups.space.rotation.y=t*.008;if(layerGroups.internet)layerGroups.internet.rotation.y=-t*.014;if(layerGroups.human)layerGroups.human.rotation.y=t*.010;if(layerGroups.physical)layerGroups.physical.rotation.y=-t*.006;allMeshes.forEach(({mesh},i)=>{mesh.scale.setScalar(1+Math.sin(t*1.6+i*.38)*.065);});controls.update();renderer.render(scene,camera);}
function escH(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
init();loadData();
</script>
{% endblock %}
